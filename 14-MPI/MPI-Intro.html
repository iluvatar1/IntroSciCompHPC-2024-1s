

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>15. Introduction to MPI (distributed memory) &#8212; Introduction to Scientific and High Performance Computing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '14-MPI/MPI-Intro';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="16. Ref" href="../15-Intro-Cuda/cuda.html" />
    <link rel="prev" title="14. Introduction to OpenMp (Shared memory)" href="../13-OpenMP/OpenMP-Intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Nanoscience_High-Performance_Computing_Facility.jpg/1600px-Nanoscience_High-Performance_Computing_Facility.jpg" class="logo__image only-light" alt="Introduction to Scientific and High Performance Computing - Home"/>
    <script>document.write(`<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Nanoscience_High-Performance_Computing_Facility.jpg/1600px-Nanoscience_High-Performance_Computing_Facility.jpg" class="logo__image only-dark" alt="Introduction to Scientific and High Performance Computing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Introduction to Scientific and High Performance Computing
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to scientific computing and programming tools</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01-Introduction/01-Introduction.html">1. Introduction</a></li>

<li class="toctree-l1"><a class="reference internal" href="../02-errorsfpnumbers/ErrorsFPNumbers.html">3. Errors in Floating Point Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04-Makefiles/04-Makefiles.html">4. Makefiles as automation tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06-stdlib-randomnumbers/06-stdlib-randomnumbers.html">5. Standard library of functions: math functions, containers and random numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07-Install-Programs-From-Source/07-Install-Programs-From-Source.html">6. Using software in a hpc environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-Debugging/09-Debugging.html">7. Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-UnitTest/09-UnitTesting.html">8. Unit Testing : Making sure your bugs don’t come back</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">High Performance Computing and Parallel Programming</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../10-optimization/10-optimization.html">9. Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10-profiling/10-profiling.html">10. Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-matrices-numericallibs/11-matrices-numericallibs.html">11. Numerical libraries in Matrix Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-matrix-performance/11-matrix-performance.html">12. Performance measurement for some matrix ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12-IntroHPC/ParallelProgramming-Intro.html">13. Introduction to High Performance Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../13-OpenMP/OpenMP-Intro.html">14. Introduction to OpenMp (Shared memory)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">15. Introduction to MPI (distributed memory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15-Intro-Cuda/cuda.html">16. Ref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15-Intro-Slurm/Slurm.html">17. HPC resource manager: Slurm</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/iluvatar1/IntroSciCompHPC-2024-1s/master?urlpath=lab/tree/14-MPI/MPI-Intro.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/iluvatar1/IntroSciCompHPC-2024-1s/blob/master/github/iluvatar1/IntroSciCompHPC-2024-1s/blob/master/14-MPI/MPI-Intro.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/iluvatar1/IntroSciCompHPC-2024-1s" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/iluvatar1/IntroSciCompHPC-2024-1s/issues/new?title=Issue%20on%20page%20%2F14-MPI/MPI-Intro.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/14-MPI/MPI-Intro.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction to MPI (distributed memory)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intro-mpi">15.1. Intro MPI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-mpi">15.2. Core MPI</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-sub-getprocessorname-sub">15.2.1. MPI<sub>Getprocessorname</sub></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-and-running-the-mpi-program">15.2.2. Compiling and running the MPI program</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-an-mpi-on-several-machines">15.2.3. Running an mpi on several machines</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-numerical-integration-send-and-recv-functions">15.3. Application: Numerical Integration (Send and Recv functions)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serial-implementation-of-the-numerical-integration-by-rectangles">15.3.1. Serial implementation of the numerical integration by rectangles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-solution-point-to-point-communication-with-mpi-sub-send-sub-and-mpi-sub-recv-sub">15.3.2. MPI solution: Point to point communication with MPI<sub>Send</sub> and MPI<sub>Recv</sub></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-point-to-point-exercises">15.4. More Point to point exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ping-pong">15.4.1. Ping-Pong</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bandwitdh-local-and-network">15.4.2. Bandwitdh local and network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#large-unit-matrix">15.4.3. Large unit matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ring-pattern">15.4.4. Ring pattern</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#collective-communications">15.5. Collective Communications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-bcast">15.5.1. MPI Bcast</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-sub-bcast-sub-mpi-sub-reduce-sub">15.5.2. MPI<sub>Bcast</sub>, MPI<sub>Reduce</sub></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">15.5.2.1. Exercises</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples-mpi-gather-mpi-scatter">15.6. More examples : <code class="docutils literal notranslate"><span class="pre">MPI_Gather</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Scatter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collective-comms-exercises">15.6.1. Collective comms exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-example-parallel-relaxation-method">15.7. Practical example: Parallel Relaxation method</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serial-version">15.7.1. Serial version</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelize-both-initial-and-boundary-conditions">15.7.2. Parallelize both initial and boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#communication">15.7.3. Communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evolution">15.7.4. Evolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">15.7.4.1. Exercises</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-in-parallel">15.8. Debugging in parallel</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-exercises">15.9. More Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-to-mpi-distributed-memory">
<h1><span class="section-number">15. </span>Introduction to MPI (distributed memory)<a class="headerlink" href="#introduction-to-mpi-distributed-memory" title="Permalink to this heading">#</a></h1>
<section id="intro-mpi">
<h2><span class="section-number">15.1. </span>Intro MPI<a class="headerlink" href="#intro-mpi" title="Permalink to this heading">#</a></h2>
<p>MPI stands for Message Passing Interface. It is a standard which allows
processes to communicate and share data across an heterogeneous setup.
MPI is well suited for distributed memory systems, although it can also
be used in multiprocessor environments (on those environments, OpenMP is
a better suited solution). Both MPI (on any of its implementations) and
OpenMP represent the most common approaches to program on a cluster
environment.</p>
<blockquote>
<div><p>NOTE: This section is heavily based on Chapter 13 of “High Performance
Linux Clusters with Oscar, Rocks, OpenMosix, and MPI”, J. D. Sloan,
O’Reilly.</p>
</div></blockquote>
<p>MPI is a library of routines which allows the parts of your parallel
program to communicate. But it is up to you how to split up your
program/problem. There are no typical restrictions on the number of
processors you can split on your problem: you can use less or more
process than the number of available processors. For that reason, MPI
allows you to tag every process with a given <em>rank</em>, on a problem of
<em>size</em> total number of processes.</p>
<p>MPI can be used as a library on several languages: Fortran, C, C++ ,
etc. In the following, we will use mostly C.</p>
</section>
<section id="core-mpi">
<h2><span class="section-number">15.2. </span>Core MPI<a class="headerlink" href="#core-mpi" title="Permalink to this heading">#</a></h2>
<p>It is typical to denote the rank-0 process as the master and the
remaining process (rank &gt;= 1) as slaves. Most of the time, the slaves
are processing several parts of the problem and then communicate back
the results to the master. All of this is managed on a single source
code which is advantageous. The following is an example of the most
fundamental MPI program which constitutes a template for more complex
programs:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">processId</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* rank of process */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">;</span><span class="w">               </span><span class="cm">/* number of processes */</span>

<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span><span class="w">                   </span><span class="cm">/* Mandatory */</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">noProcesses</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">processId</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello from process %d of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">processId</span><span class="p">,</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">);</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span><span class="w">                       </span><span class="cm">/* Mandatory */</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Before compiling and running, we will explain the code. First of all,
the MPI functions are added by the inclusion of the <code class="docutils literal notranslate"><span class="pre">mpi.h</span></code> header. The
two mandatory functions <code class="docutils literal notranslate"><span class="pre">MPI_Init</span></code> and <code class="docutils literal notranslate"><span class="pre">MPI_Finalize</span></code>, must be always
present. They set-up and destroy the MPI running environment. The other
two, <code class="docutils literal notranslate"><span class="pre">MPI_Comm_size</span></code> and <code class="docutils literal notranslate"><span class="pre">MPI_Comm_rank</span></code> allows to identify the size of
the problem (number of processes) and the rank of the current process.
This allows to distinguish the master from the slaves and to split the
problem.</p>
<p>MPI<sub>Init</sub><br />
This function call <strong>must</strong> occur before any other MPI function call.
This function initializes the MPI session. It receives the argc and argv
arguments, as shown, which allows the program to read command line
arguments.</p>
<p>MPI<sub>Finalize</sub><br />
This function releases the MPI environment. This should be the last call
to MPI in the program, after all communications have ended. Your code
must be written in such a way that all processes call this function.</p>
<p>MPI<sub>Commsize</sub><br />
This function returns the total number of processes running on a
communicator. A communicator is the communication group used by the
processes. The default communicator is <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code>. You can create
your own communicators to isolate several sub-groups of processes.</p>
<p>MPI<sub>Commrank</sub><br />
Returns the actual rank of the calling process, inside the communicator
group. The range goes from 0 to the the size minus 1.</p>
<section id="mpi-sub-getprocessorname-sub">
<h3><span class="section-number">15.2.1. </span>MPI<sub>Getprocessorname</sub><a class="headerlink" href="#mpi-sub-getprocessorname-sub" title="Permalink to this heading">#</a></h3>
<p>This retrieves the hostname of the current and is very useful for
debugging purposes. The following example shows how to get the node name</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">processId</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* rank of process */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">;</span><span class="w">               </span><span class="cm">/* number of processes */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nameSize</span><span class="p">;</span><span class="w">              </span><span class="cm">/* lenght of name */</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">computerName</span><span class="p">[</span><span class="n">MPI_MAX_PROCESSOR_NAME</span><span class="p">];</span>

<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span><span class="w">                   </span><span class="cm">/* Mandatory */</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">noProcesses</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">processId</span><span class="p">);</span>

<span class="w">  </span><span class="n">MPI_Get_processor_name</span><span class="p">(</span><span class="n">computerName</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nameSize</span><span class="p">);</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello from process %d of %d, on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">processId</span><span class="p">,</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">,</span><span class="w"> </span><span class="n">computerName</span><span class="p">);</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span><span class="w">                       </span><span class="cm">/* Mandatory */</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="compiling-and-running-the-mpi-program">
<h3><span class="section-number">15.2.2. </span>Compiling and running the MPI program<a class="headerlink" href="#compiling-and-running-the-mpi-program" title="Permalink to this heading">#</a></h3>
<p>Compilation can be done directly with the gcc compiler by using the
appropriate flags. But there is a helper command ready to help you:
<code class="docutils literal notranslate"><span class="pre">mpicc</span></code>. Save the previous example code into a file (here called
<code class="docutils literal notranslate"><span class="pre">mpi-V1.c</span></code>) and run the following command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mpicc<span class="w"> </span>mpi-V1.c<span class="w"> </span>-o<span class="w"> </span>hello.x
</pre></div>
</div>
<p>If you run the command as usual, it will expand to the number of local
cores and run locally only (for example, ina two cores system):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./hello.x
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>of<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>of<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
</pre></div>
</div>
<p>But, there is another utility which allows you to specify several
parameters, like the number of processes to span, among others:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">5</span><span class="w"> </span>./hello.x
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">3</span><span class="w"> </span>of<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>of<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">4</span><span class="w"> </span>of<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>of<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
Hello<span class="w"> </span>from<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>of<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>on<span class="w"> </span>iluvatarMacBookPro.local
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Exercise: Print the output sorted.</p></li>
</ol>
</section>
<section id="running-an-mpi-on-several-machines">
<h3><span class="section-number">15.2.3. </span>Running an mpi on several machines<a class="headerlink" href="#running-an-mpi-on-several-machines" title="Permalink to this heading">#</a></h3>
<p>You can run an mpi process on the same machine or in several machines,
as follows</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>-host<span class="w"> </span>host01,host02<span class="w"> </span>./a.out
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">host01</span></code>, etc is the hostname where you want to run the process.
You will need to have access by ssh to those hosts, and preferable, a
password-less <a class="reference external" href="http://lmgtfy.com/?q=passwordless+ssh">setup</a> . See also
the manual for <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> .</p>
<p>You can specify a machine file for mpi tu use them and run the command
with given resources. An example machine files is as follows</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hostname1<span class="w"> </span><span class="nv">slots</span><span class="o">=</span><span class="m">2</span>
hostname2<span class="w"> </span><span class="nv">slots</span><span class="o">=</span><span class="m">4</span>
hostname3<span class="w"> </span><span class="nv">slots</span><span class="o">=</span><span class="m">6</span>
</pre></div>
</div>
<p>where hostname is the ip or the hostname of a given machine and the
slots indicates how many jobs to run. You will need to have a
passwordless access or similar to those computers.</p>
<p>To configure the passwordless ssh, you can follow the many tutorials
online, which basically are the following steps</p>
<ul>
<li><p>Generate the rsa key</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa
</pre></div>
</div>
<p>Do not set ay passphrase, just press enter.</p>
</li>
<li><p>Copy the id to the computer where you want to run processes
remotely,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ssh-copy-id<span class="w"> </span><span class="m">192</span>.168.10.16
</pre></div>
</div>
<p>Enter your password for the last time. If everything goes ok, test
that you can login remotely without password by runnung</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ssh 192.168.10.16
</pre></div>
</div>
</li>
</ul>
<p>Now you can run the process remotely:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">100</span><span class="w"> </span>-host<span class="w"> </span><span class="m">192</span>.168.10.15,192.168.10.16<span class="w"> </span>--oversubscribe<span class="w"> </span>./a.out
</pre></div>
</div>
</section>
</section>
<section id="application-numerical-integration-send-and-recv-functions">
<h2><span class="section-number">15.3. </span>Application: Numerical Integration (Send and Recv functions)<a class="headerlink" href="#application-numerical-integration-send-and-recv-functions" title="Permalink to this heading">#</a></h2>
<p>To improve our understanding of MPI, and to introduce new functions, we
will use a familiar problem to investigate: the computation of the area
under a curve. Its easiness and familiarity allows to focus on MPI and
its usage. Let’s introduce first the serial version.</p>
<section id="serial-implementation-of-the-numerical-integration-by-rectangles">
<h3><span class="section-number">15.3.1. </span>Serial implementation of the numerical integration by rectangles<a class="headerlink" href="#serial-implementation-of-the-numerical-integration-by-rectangles" title="Permalink to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>

<span class="cm">/* Problem parameters */</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">integral_serial</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberRects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lowerLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">upperLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="p">;</span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">integral_serial</span><span class="p">(</span><span class="n">lowerLimit</span><span class="p">,</span><span class="w"> </span><span class="n">upperLimit</span><span class="p">,</span><span class="w"> </span><span class="n">numberRects</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The area from %lf to %lf is : %lf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lowerLimit</span><span class="p">,</span><span class="w"> </span><span class="n">upperLimit</span><span class="p">,</span><span class="w"> </span><span class="n">integral</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">integral_serial</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// center in the middle</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">heigth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">at</span><span class="p">);</span>
<span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">*</span><span class="n">heigth</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile and run it :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>g++<span class="w"> </span>serial_integral.cpp
$<span class="w"> </span>./a.out
The<span class="w"> </span>area<span class="w"> </span>from<span class="w"> </span><span class="m">2</span>.000000<span class="w"> </span>to<span class="w"> </span><span class="m">5</span>.000000<span class="w"> </span>is<span class="w"> </span>:<span class="w"> </span><span class="m">38</span>.999100
</pre></div>
</div>
<p>Now let’s implement an mpi solution.</p>
</section>
<section id="mpi-solution-point-to-point-communication-with-mpi-sub-send-sub-and-mpi-sub-recv-sub">
<h3><span class="section-number">15.3.2. </span>MPI solution: Point to point communication with MPI<sub>Send</sub> and MPI<sub>Recv</sub><a class="headerlink" href="#mpi-solution-point-to-point-communication-with-mpi-sub-send-sub-and-mpi-sub-recv-sub" title="Permalink to this heading">#</a></h3>
<p>Check: <a class="reference external" href="https://mpitutorial.com/tutorials/mpi-send-and-receive/">https://mpitutorial.com/tutorials/mpi-send-and-receive/</a></p>
<p>This is an embarrassingly parallel problem. There are no data
dependencies. We can partition the domain, performing partial sums per
process, and then cumulate all of them. Basically, we will use
<code class="docutils literal notranslate"><span class="pre">MPI_Comm_rank</span></code> and <code class="docutils literal notranslate"><span class="pre">MPI_Comm_size</span></code> to partition the problem, and we
will introduce two new functions: <code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code>, to send data, and
<code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code>, to receive data. These are known as blocking, point-to-point
communications.</p>
<p>Before checking the code, please <strong>work in groups</strong> to deduce the right
problem partition (keeping the same number of inteervals per process)
and how to communicate data. Use a shared whiteboard, like google
jamboard.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>

<span class="cm">/* Problem parameters */</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">integral_serial</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">integral_mpi</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberRects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">lowerLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">upperLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* MPI Variables */</span>

<span class="w">  </span><span class="cm">/* problem variables */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* MPI setup */</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>

<span class="w">  </span><span class="n">integral_mpi</span><span class="p">(</span><span class="n">lowerLimit</span><span class="p">,</span><span class="w"> </span><span class="n">upperLimit</span><span class="p">,</span><span class="w"> </span><span class="n">numberRects</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* finish */</span>
<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">integral_serial</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// center in the middle</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">heigth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">at</span><span class="p">);</span>
<span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">*</span><span class="n">heigth</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">integral_mpi</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Adjust problem size for sub-process */</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xmin</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">range</span><span class="o">*</span><span class="n">pid</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Calculate area for subproblem */</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">integral_serial</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="o">+</span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Collect info and print results */</span>
<span class="w">  </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Master */</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">np</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="w">      </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The area from %g to %g is : %25.16e</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* slaves only send */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>


<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile as usual,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mpic++<span class="w"> </span>mpi_integral.cpp
</pre></div>
</div>
<p>and run it</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">2</span><span class="w"> </span>./a.out
$<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">10</span><span class="w"> </span>./a.out
</pre></div>
</div>
<blockquote>
<div><p>Exercise: Play with the number of processes. Are you getting a better
answer for increasing number of processes?</p>
</div></blockquote>
<p>In this example we have kept constant the number of rectangles per
range. That means that as the number of processess increases, the total
number of rectangles increases too, since each process has the same
original number of rectangles. Therefore, the more the processes, the
better the precision. If you prefer speed over precision, you will have
to fix the total number of rectangles, whose number per processor will
decrease.</p>
<blockquote>
<div><p><strong>Exercise</strong> : Change the previous code to handle a constant number of
rectangles. As you increase the number of processors, is the precision
increasing? or the speed?</p>
</div></blockquote>
<p>The important part here is the scaling of the problem to the actual
number of processes. For example, for five processes, we need first to
divide the total interval (from 2 to 5 in tis example) into the number
of processes, and then take each one of this sub-intervals and process
it on the given process (identified by processId). This is called a
domain-decomposition approach.</p>
<p>At the end of the code, we verify if we are on a slave or on the master.
If we are the master, we receive all the partial integrations sent by
the slaves, and then we print the total. If we are a slave, we just send
our result back to the master (destination = 0). Using these functions
is simple but not always efficient since, for example, for 100
processes, we are calling <code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code> and <code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code> 99 times.</p>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code><br />
used to send information to one process to another. A call to <code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code>
<em>MUST</em> be matched with a corresponding <code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code> . Information is typed
(the type is explicitly stated), and tagged. The first argument of
<code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code> gives the starting address of the data to be transmitted. The
second is the number of items to be sent, and the third one is the data
type (<code class="docutils literal notranslate"><span class="pre">MPI_DOUBLE</span></code>). There are more datatypes like <code class="docutils literal notranslate"><span class="pre">MPI_BYTE</span></code>,
<code class="docutils literal notranslate"><span class="pre">MPI_CHAR</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_UNSIGNED</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_INT</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_FLOAT</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_PACKED</span></code>, etc.
The next argument is the destination, that is, the rank of the receiver.
The next one is a tag, which is used for buffer purposes. Finally, the
(default) communicator is used.</p>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code><br />
allows to receive information sent by <code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code>. Its first three
arguments are as before. Then it comes the destination (rank of the
receiving process), the tag, the communicator, and a status flag.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code> and <code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code> are blocking calls. If a process is
receiving information which has not been sent yet, if waits until it
receives that info without doing anything else.</p>
<p>Before continue, please check the following mpi functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MPI_ISend</span> <span class="pre">,</span> <span class="pre">MPI_Irecv</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MPI_Sendrecv</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MPI_Sendrecv_replace</span></code></p></li>
</ul>
<blockquote>
<div><p><strong>Exercise:</strong> Discuss if any of the previous can be used for the
integral. Or what pattern would you think could be useful? maybe a
reduction?</p>
</div></blockquote>
</section>
</section>
<section id="more-point-to-point-exercises">
<h2><span class="section-number">15.4. </span>More Point to point exercises<a class="headerlink" href="#more-point-to-point-exercises" title="Permalink to this heading">#</a></h2>
<p>Check also:
<a class="reference external" href="http://www.archer.ac.uk/training/course-material/2017/09/mpi-york/exercises/MPP-exercises.pdf">http://www.archer.ac.uk/training/course-material/2017/09/mpi-york/exercises/MPP-exercises.pdf</a></p>
<section id="ping-pong">
<h3><span class="section-number">15.4.1. </span>Ping-Pong<a class="headerlink" href="#ping-pong" title="Permalink to this heading">#</a></h3>
<p>Ref: Gavin, EPCC</p>
<ul class="simple">
<li><p>Write an MPI code for 2 processes</p></li>
<li><p>The first task sends a message to the second task</p></li>
<li><p>The message can be a single integer</p></li>
<li><p>The second task receives this message</p></li>
<li><p>The second task changes the message somehow</p>
<ul>
<li><p>Add 99 to the original message, for instance</p></li>
</ul>
</li>
<li><p>The second task sends the message back to the first task</p></li>
<li><p>The first task receives the message</p></li>
<li><p>The first task prints this new message to the screen</p></li>
</ul>
<p>Maybe repeat M times</p>
</section>
<section id="bandwitdh-local-and-network">
<h3><span class="section-number">15.4.2. </span>Bandwitdh local and network<a class="headerlink" href="#bandwitdh-local-and-network" title="Permalink to this heading">#</a></h3>
<p>Compute the bandwidth when sending data locally (same computer) and to
other computer in the network. Plot the time taken to send the data as a
function of the buffer size. Is the bandwidth (Mbits/s) constant? is
there any difference between local and multimachine data sending?</p>
</section>
<section id="large-unit-matrix">
<h3><span class="section-number">15.4.3. </span>Large unit matrix<a class="headerlink" href="#large-unit-matrix" title="Permalink to this heading">#</a></h3>
<p>Imagine a large unit matrix that is distributed among all the processes
in horizontal layers. Each process stores only its corresponding matrix
part, not the full matrix. Make each process fill its corresponding part
and then print the full matrix in the right order in the master process
by sending each process matrix section to the master. Also plot it in
gnupot or matplotlib</p>
</section>
<section id="ring-pattern">
<h3><span class="section-number">15.4.4. </span>Ring pattern<a class="headerlink" href="#ring-pattern" title="Permalink to this heading">#</a></h3>
<p>Ref: Gavin, EPCC</p>
<ul class="simple">
<li><p>Write an MPI code which sends a message around a ring</p></li>
<li><p>Each MPI task receives from the left and passes that message on to
the right</p></li>
<li><p>Every MPI task sends a message: Its own rank ID</p></li>
<li><p>How many steps are required for the message to return ‘home’.</p></li>
<li><p>Update the code so that each MPI Tasks takes the incoming message
(an integer), and adds it to a running total</p></li>
<li><p>What should the answer be on MPI Task 0 . Is the answer the same on
all tasks? (Test with unblocking send and even/odd send receive)</p></li>
</ul>
</section>
</section>
<section id="collective-communications">
<h2><span class="section-number">15.5. </span>Collective Communications<a class="headerlink" href="#collective-communications" title="Permalink to this heading">#</a></h2>
<p>Check:
<a class="reference external" href="https://mpitutorial.com/tutorials/mpi-broadcast-and-collective-communication/">https://mpitutorial.com/tutorials/mpi-broadcast-and-collective-communication/</a></p>
<p>If you check some of the previous code, or the integral code, we are
sending the same info over and over to every other process. While the
master sends the data to process 1, the remaining processes are idle.
This is not efficient. Fortunately, MPI provides several functions to
improve this situation, where the overall communication is managed much
better. The first function is <code class="docutils literal notranslate"><span class="pre">MPI_Bcast</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Bcast</span></code>
provides a mechanism to distribute the same information</p>
<p>among a communicator group, in an efficient manner. It takes five
arguments. The first three are the data to be transmitted, as usual. The
fourth one is the rank of the process generating the broadcast, a.k.a
the root of the broadcast. The final argument is the communicator
identifier. See:
<a class="reference external" href="https://www.open-mpi.org/doc/v4.1/man3/MPI_Bcast.3.php">https://www.open-mpi.org/doc/v4.1/man3/MPI_Bcast.3.php</a> . The syntax is</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span>
<span class="w">              </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">root</span></code> is the one sending the data in buffer to all other
processes.</p>
<img alt="../_images/mpi_broadcast.png" class="centerimg50" src="../_images/mpi_broadcast.png" />
<p>It could be internally optimized to reduce calls</p>
<img alt="../_images/mpi_broadcast_ex.png" class="centerimg50" src="../_images/mpi_broadcast_ex.png" />
<p><code class="docutils literal notranslate"><span class="pre">MPI_Reduce</span></code><br />
allows to collect data and, at the same time, perform a</p>
<p>mathematical operation on it (like collecting the partial results and
then summing up them). It requires not only a place where to put the
results but also the operator to be applied. This could be, for example,
<code class="docutils literal notranslate"><span class="pre">MPI_SUM</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_MIN</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_MAX</span></code>, etc. It also needs the identifier of
the root of the broadcast. Both this functions will simplify a lot the
code, and also make it more efficient (since the data distribution and
gathering is optimised).
<a class="reference external" href="https://mpitutorial.com/tutorials/mpi-reduce-and-allreduce/">https://mpitutorial.com/tutorials/mpi-reduce-and-allreduce/</a></p>
<img alt="../_images/mpi_reduce.png" class="centerimg50" src="../_images/mpi_reduce.png" />
<p>Check:
<a class="reference external" href="https://mpitutorial.com/tutorials/mpi-broadcast-and-collective-communication/">https://mpitutorial.com/tutorials/mpi-broadcast-and-collective-communication/</a>
<a class="reference external" href="http://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture29.pdf">http://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture29.pdf</a></p>
<section id="mpi-bcast">
<h3><span class="section-number">15.5.1. </span>MPI Bcast<a class="headerlink" href="#mpi-bcast" title="Permalink to this heading">#</a></h3>
<ol class="arabic">
<li><p>Sending an array from one source to all processes</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;numeric&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_collective</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* MPI setup */</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="n">send_data_collective</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_collective</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create data buffer (all processes)</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">iota</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">+</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"> </span><span class="c1">// llena como 0 1 2 3 4</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// send data to all processes</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">();</span>
<span class="w">  </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// print size, time, bw in root</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">datasize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">datasize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">datasize</span><span class="o">/</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mf">1.0e6</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>[Minihomework] Mesuring the bandwidth and comparing with simple
send and recv</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;numeric&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_collective</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_point_to_point</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* MPI setup */</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="n">send_data_collective</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_point_to_point</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// ???</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_data_collective</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create data buffer (all processes)</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">iota</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">+</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// send data to all processes</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">();</span>
<span class="w">  </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// print size, time, bw in root</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">datasize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">datasize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">datasize</span><span class="o">/</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mf">1.0e6</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="mpi-sub-bcast-sub-mpi-sub-reduce-sub">
<h3><span class="section-number">15.5.2. </span>MPI<sub>Bcast</sub>, MPI<sub>Reduce</sub><a class="headerlink" href="#mpi-sub-bcast-sub-mpi-sub-reduce-sub" title="Permalink to this heading">#</a></h3>
<p>In this case we will read some data in process 0 , then broadcast it to
other processes, and finally reduce back some result (an integral , in
this example).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>

<span class="cm">/* Problem parameters */</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* MPI Variables */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">,</span><span class="w"> </span><span class="n">processId</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* problem variables */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">at</span><span class="p">,</span><span class="w"> </span><span class="n">heigth</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">numberRects</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">lowerLimit</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">upperLimit</span><span class="p">;</span>


<span class="w">  </span><span class="cm">/* MPI setup */</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">noProcesses</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">processId</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* read, send, and receive parameters */</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">processId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enter number of steps: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberRects</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enter lower limit: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%lf&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lowerLimit</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enter upper limit: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%lf&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">upperLimit</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Broadcast the read data parameters*/</span>
<span class="w">  </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numberRects</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_INT</span><span class="p">,</span><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lowerLimit</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">upperLimit</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Adjust problem size for sub-process */</span>
<span class="w">  </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">upperLimit</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lowerLimit</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">noProcesses</span><span class="p">;</span>
<span class="w">  </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">numberRects</span><span class="p">;</span>
<span class="w">  </span><span class="n">lower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lowerLimit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">range</span><span class="o">*</span><span class="n">processId</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Calculate area for subproblem */</span>
<span class="w">  </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberRects</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">heigth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">at</span><span class="p">);</span>
<span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">width</span><span class="o">*</span><span class="n">heigth</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Collect and reduce data */</span>
<span class="w">  </span><span class="n">MPI_Reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_SUM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* print results */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">processId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Master */</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The area from %g to %g is : %25.16e</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lowerLimit</span><span class="p">,</span><span class="w"> </span><span class="n">upperLimit</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* finish */</span>
<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The eight functions <code class="docutils literal notranslate"><span class="pre">MPI_Init</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Comm_size</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Comm_rank</span></code>,
<code class="docutils literal notranslate"><span class="pre">MPI_Send</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Recv</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Bcast</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Reduce</span></code>, and <code class="docutils literal notranslate"><span class="pre">MPI_Finalize</span></code>
are the core of the MPI programming. You are now and MPI programmer.</p>
<section id="exercises">
<h4><span class="section-number">15.5.2.1. </span>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h4>
<ol class="arabic simple">
<li><p>Modularize the previous integral code with functions. Basically use
the same code as with send/recv but adapt it to use bcast/reduce.</p></li>
<li><p>Do the same for the problem of computing the L2 norm (Euclidean
norm) of a very large vector. Fill it with ones and test the answer.
What kind of cpu time scaling do you get as function of the number
of processes, with N = 100000?</p></li>
<li><p>Filling randomly a matrix with probability <span class="math notranslate nohighlight">\(p\)</span>: Make process 0 send
the value of <span class="math notranslate nohighlight">\(p\)</span> to all processes. Also, distribute the matrix (only
one slice per process). Fill the matrix at each process with prob
<span class="math notranslate nohighlight">\(p\)</span>. To verify, compute, at each process, the total places filled
and send it to process 0. Add up all of them and print (from
process 0) both the total proportion of filled sites (must be close
to <span class="math notranslate nohighlight">\(p\)</span>) and the full matrix. Think if the algorithm that you devised
to detect percolant clusters can be parallelized.</p></li>
</ol>
</section>
</section>
</section>
<section id="more-examples-mpi-gather-mpi-scatter">
<h2><span class="section-number">15.6. </span>More examples : <code class="docutils literal notranslate"><span class="pre">MPI_Gather</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Scatter</span></code><a class="headerlink" href="#more-examples-mpi-gather-mpi-scatter" title="Permalink to this heading">#</a></h2>
<p>Check:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://mpitutorial.com/tutorials/mpi-scatter-gather-and-allgather/">https://mpitutorial.com/tutorials/mpi-scatter-gather-and-allgather/</a></p></li>
<li><p><a class="reference external" href="http://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture29.pdf">http://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture29.pdf</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Collective_operation">https://en.wikipedia.org/wiki/Collective_operation</a></p></li>
</ul>
<p>Functions :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MPI_Scatter:</span></code> Sends parts of a given data to corresponding
processes. Example: Array 16 doubles. You have 4 processes. Then
this functions sends the first 4 doubles to rank 0, the second 4
doubles to rank 1, and so on. Note: The original array must exists
on the sending process, so this might limit its size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MPI_Gather:</span></code> It is the opposite. Recovers data from all processes
and stores it on the root process.</p></li>
</ul>
<p>Now let’s do some a program to practice them. This program will compute
the average of a set of random numbers. We will try not to share the
full array of random numbers, but instead to make each process create
its own array. We will use a Gaussian random number generator with mean
1.23 and sigma 0.45:</p>
<ul class="simple">
<li><p>Share with all processes the local array size (<code class="docutils literal notranslate"><span class="pre">N/np</span></code>, where <code class="docutils literal notranslate"><span class="pre">N</span></code> is
the array size and <code class="docutils literal notranslate"><span class="pre">np</span></code> is the number of processes), the mean and
the sigma.</p></li>
<li><p>Share with all process the seed for the local random number
generator. The seed might be the rank. Store the seeds on a local
array and then send them from rank 0.</p></li>
<li><p>Compute the local sum on each process.</p></li>
<li><p>Get the local sum by storing it on the seeds array (for now, don’t
reduce).</p></li>
<li><p>Compute the mean and print it.</p></li>
</ul>
<p>There are many other collective communications functions worth
mentioning (<a class="reference external" href="https://en.wikipedia.org/wiki/Collective_operation">https://en.wikipedia.org/wiki/Collective_operation</a> ,
<a class="reference external" href="https://www.mpi-forum.org/docs/mpi-1.1/mpi-11-html/node64.html">https://www.mpi-forum.org/docs/mpi-1.1/mpi-11-html/node64.html</a>,
<a class="reference external" href="https://www.rookiehpc.com/mpi/docs/index.php">https://www.rookiehpc.com/mpi/docs/index.php</a> ):</p>
<ul class="simple">
<li><p>MPI<sub>Scatter</sub> and MPI<sub>Gather</sub></p></li>
<li><p>MPI<sub>AllGather</sub> and MPI<sub>Alltoall</sub></p></li>
<li><p>MPI<sub>Scatterv</sub></p></li>
<li><p>MPI<sub>Reduce</sub>, MPI<sub>Scan</sub>, MPI<sub>ExScan</sub>,
Reduce<sub>Scatter</sub></p></li>
</ul>
<p><strong>Exercise:</strong> Each group will implement a working example of each of the
following functions, as follows:
<a class="reference external" href="https://www.rookiehpc.com/mpi/docs/index.php">https://www.rookiehpc.com/mpi/docs/index.php</a></p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Group</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>MPI<sub>scatter</sub> and MPI<sub>Gather</sub>, MPI<sub>allgather</sub></p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>MPI<sub>Scatterv</sub>, MPI<sub>Gatherv</sub></p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>MPI<sub>Alltoall</sub>, MPI<sub>alltoallv</sub></p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>MPI<sub>Reduce</sub>, MPI<sub>Reducescatter</sub></p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>MPI<sub>Scan</sub>, MPI<sub>Exscan</sub></p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>MPI<sub>All</sub>`Reduce with many MPI<sub>OP</sub> (min, max, sum , mult)</p></td>
</tr>
</tbody>
</table>
<section id="collective-comms-exercises">
<h3><span class="section-number">15.6.1. </span>Collective comms exercises<a class="headerlink" href="#collective-comms-exercises" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Revisit all point-to-point comms exercises and implement them using
collective comms if possible.</p></li>
<li><p>Ring code REF: Gavin, EPCC</p>
<ul class="simple">
<li><p>Use a Collective Communications routine to produce the same
result as your Ring Code so that only Task 0 ‘knows’ the answer.</p></li>
<li><p>Now change the Collective Communications call so all tasks
‘know’ the answer.</p></li>
<li><p>Can you think of another way to implement the collective
communications routine than the Ring Code?</p></li>
<li><p>Compare the execution times for both the Ring Code and the
associated Collective Communication routine.</p></li>
<li><p>Which is faster?</p></li>
<li><p>Why do the times change so much when you run it again and again?</p></li>
<li><p>What happens when the size of the message goes from 1
MPI<sub>INT</sub> to 10000 MPI<sub>INTs</sub>?!</p></li>
</ul>
</li>
<li><p>Scaling for mpi integral Compute the scaling of the mpi integral
code when using point to point and collective communications, in the
same machine. Then do the same for two machines, dividing the number
of processes among them.</p></li>
<li><p>You will compute the polynomial <span class="math notranslate nohighlight">\(f(x) = x + x^{2} + x^{3} +
  x^{4} + \ldots + x^{N}\)</span>. Write an mpi program that computes this
in <span class="math notranslate nohighlight">\(N\)</span> processes and prints the final value on master (id = 0) for
<span class="math notranslate nohighlight">\(x = 0.987654\)</span> and <span class="math notranslate nohighlight">\(N = 25\)</span>. Use broadcast communications when
possible.</p></li>
<li><p>Compute the mean of a large array by distributing it on several
processes. Your program must print the partial sums on each node and
the final mean on master.</p></li>
<li><p>Compute the value of <span class="math notranslate nohighlight">\(\pi\)</span> by using the montecarlo method: Imagine a
circle of radius 1. Its area would be <span class="math notranslate nohighlight">\(\pi\)</span>. Imagine now the circle
inscribed inside a square of length 2. Now compute the area (<span class="math notranslate nohighlight">\(\pi\)</span>)
of the circle by using a simple Monte-Carlo procedure: just throw
some random points inside the square (<span class="math notranslate nohighlight">\(N_s\)</span>) and count the number of
points that fall inside the circle (<span class="math notranslate nohighlight">\(N_c\)</span>). The ratio of the areas
is related with the ratio of inner points as <span class="math notranslate nohighlight">\(A_c/A_s
  \simeq N_c/N_s\)</span>, therefore <span class="math notranslate nohighlight">\(A_C \simeq A_s N_c/N_s\)</span>. Use as many
processes as possible to increase the precision. At the end print
the total number of points tested, the value of <span class="math notranslate nohighlight">\(\pi\)</span> found, and the
percent difference with the expected value, <span class="math notranslate nohighlight">\(\Delta\)</span>. Plot <span class="math notranslate nohighlight">\(\Delta\)</span>
as function of <span class="math notranslate nohighlight">\(N_p\)</span>.</p></li>
</ol>
</section>
</section>
<section id="practical-example-parallel-relaxation-method">
<h2><span class="section-number">15.7. </span>Practical example: Parallel Relaxation method<a class="headerlink" href="#practical-example-parallel-relaxation-method" title="Permalink to this heading">#</a></h2>
<p>In this example we will parallelize the relaxation method by using MPI.
We will decompose the domain, add some ghost zones and finally transmit
some information between different processors. Our tasks will be as
follows:</p>
<ol class="arabic simple">
<li><p>Probar la version serial.</p></li>
<li><p>Por cada proceso, crear el arreglo local incluyendo los ghosts:
Probar llenando esta matriz con el pid y luego imprimir la matriz
completa incluyendo y sin incluir los ghost (inicialización)</p></li>
<li><p>Paralelizar la inicializacion e imprimir comparando con la version
serial.</p></li>
<li><p>Paralelizar las condiciones de frontera</p></li>
<li><p>Comunicacion entre procesos: Enviar y recibir de vecinos y guardar
en las zonas ghost. Imprimir para verificar. Introducir y probar
diversas formas de comunicación, como Send y Recv, llamadas no
bloqueantes, Sendrecv, y MPI<sub>Neighborªlltoallw</sub> con
MPI<sub>Createcart</sub>.</p></li>
<li><p>Paralelizar la evolucion. Tener en cuenta las condiciones de
frontera.</p></li>
<li><p>Medir metricas paralelas y medir el tiempo de comunicacion.</p></li>
<li><p>Extender a codiciones de frontera internas Usar un arreglo booleano
que indique si una celda es frintera</p></li>
<li><p>Calcular tambien el campo y/o densidades de carga.</p></li>
</ol>
<p>To decompose the domain, we will split the original matriz in horizontal
slices, one per processor (we assume <span class="math notranslate nohighlight">\(N%n_p == 0\)</span>). The data array, for
each processor, we will add two ghost rows to copy the boundary
information in order to make the evolution locally. Therefore, after
each update iteration, sync to the ghosts zones is needed. Locally each
array will be of size <span class="math notranslate nohighlight">\((N_{l} +
2)\times N\)</span>, where <span class="math notranslate nohighlight">\(N_l = N/n_p\)</span> and there are 2 ghost rows. The
following diagram illustrates the process:
<img alt="../_images/Laplace-domain-ghostscells.png" class="centerimg50" src="../_images/Laplace-domain-ghostscells.png" /></p>
<section id="serial-version">
<h3><span class="section-number">15.7.1. </span>Serial version<a class="headerlink" href="#serial-version" title="Permalink to this heading">#</a></h3>
<p>This version solves the Laplace equation by using the Jacbi-Gauss-Seidel
relaxation method and prints gnuplot commands to create an animation.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>

<span class="c1">// constants</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.479</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">DELTA</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">  </span><span class="c1">//init_gnuplot();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">istep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">istep</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">STEPS</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">istep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">evolve</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//plot_gnuplot(data);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">istep</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STEPS</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">print</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// check if boundary</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// evolve non boundary</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                    </span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ii</span><span class="o">*</span><span class="n">DELTA</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jj</span><span class="o">*</span><span class="n">DELTA</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set terminal gif animate &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set out &#39;anim.gif&#39; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Exercise:</strong> Now just try to add the very basic mpi calls without
actually parallelizing:</p>
</section>
<section id="parallelize-both-initial-and-boundary-conditions">
<h3><span class="section-number">15.7.2. </span>Parallelize both initial and boundary conditions<a class="headerlink" href="#parallelize-both-initial-and-boundary-conditions" title="Permalink to this heading">#</a></h3>
<p>The folowing code shows a possible parallelization for the initial
conditions, plus some auxiliary functions to print the matrix using
point to poin comms:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>

<span class="c1">// constants</span>
<span class="c1">// const double DELTA = 0.05;</span>
<span class="c1">// const double L = 1.479;</span>
<span class="c1">// const int N = int(L/DELTA)+1;</span>
<span class="c1">// const int STEPS = 200;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="c1">// parallel versions</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">N</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// problem partition</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">np</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// include ghosts</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">NROWS</span><span class="o">*</span><span class="n">NCOLS</span><span class="p">);</span><span class="w"> </span><span class="c1">// include ghosts cells</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After initial conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After boundary conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">  // Serial version</span>
<span class="cm">  Matrix data(N*N);</span>
<span class="cm">  initial_conditions(data, N, N, ...);</span>
<span class="cm">  print_screen(...);</span>
<span class="cm">  boundary_conditions(data, N, N, ...);</span>
<span class="cm">  init_gnuplot();</span>
<span class="cm">  for (int istep = 0; istep &lt; STEPS; ++istep) {</span>
<span class="cm">  evolve(data, N, N);</span>
<span class="cm">  plot_gnuplot(data, DELTA, N, N);</span>
<span class="cm">  }</span>
<span class="cm">  */</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// Parallel implementations</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// same task for all pids, but fill with the pids to distinguish among thems</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// TODO</span>
<span class="w">  </span><span class="c1">// Take into account each pid</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// TODO</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// ignore ghosts</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// SERIAL VERSIONS</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// check if boundary</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// evolve non boundary</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ii</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jj</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set terminal gif animate &quot; &lt;&lt; std::endl;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set out &#39;anim.gif&#39; &quot; &lt;&lt; std::endl;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Exercise</strong></p>
<p>Complete the needed functions to paralelize the boundary conditions and
printing.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="c1">// parallel versions</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">N</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// problem partition</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">np</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// include ghosts</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">NROWS</span><span class="o">*</span><span class="n">NCOLS</span><span class="p">);</span><span class="w"> </span><span class="c1">// include ghosts cells</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After initial conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After boundary conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">  // Serial version</span>
<span class="cm">  Matrix data(N*N);</span>
<span class="cm">  initial_conditions(data, N, N, ...);</span>
<span class="cm">  print_screen(...);</span>
<span class="cm">  boundary_conditions(data, N, N, ...);</span>
<span class="cm">  init_gnuplot();</span>
<span class="cm">  for (int istep = 0; istep &lt; STEPS; ++istep) {</span>
<span class="cm">  evolve(data, N, N);</span>
<span class="cm">  plot_gnuplot(data, DELTA, N, N);</span>
<span class="cm">  }</span>
<span class="cm">  */</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// Parallel implementations</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// same task for all pids, but fill with the pids to distinguish among thems</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Take into account each pid</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">boundary</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">print</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// ignore ghosts</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// SERIAL VERSIONS</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// check if boundary</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// evolve non boundary</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ii</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jj</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set terminal gif animate &quot; &lt;&lt; std::endl;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set out &#39;anim.gif&#39; &quot; &lt;&lt; std::endl;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You should get something like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>codes
mpic++<span class="w"> </span>MPI_laplace_v1.cpp
mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>--oversubscribe<span class="w"> </span>./a.out<span class="w"> </span>./a.out<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">1</span>.4705<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>After<span class="w"> </span>initial<span class="w"> </span>conditions<span class="w"> </span>...
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span>
<span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span>
<span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span>
<span class="w"> </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span>
<span class="w"> </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span>
<span class="w"> </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span>
<span class="w"> </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span>
<span class="w"> </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span>
<span class="w"> </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span>
After<span class="w"> </span>boundary<span class="w"> </span>conditions<span class="w"> </span>...
<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
</pre></div>
</div>
</section>
<section id="communication">
<h3><span class="section-number">15.7.3. </span>Communication<a class="headerlink" href="#communication" title="Permalink to this heading">#</a></h3>
<p>Here we explore how to implement the communication among the processes
using the ring topology. Your task is to implement the communication in
the following ways using</p>
<ul class="simple">
<li><p>Typical Send and Recv calls</p></li>
<li><p>Using non-blocking sends</p></li>
<li><p>Using the function MPI<sub>sendrecv</sub></p></li>
<li><p>Using MPI<sub>createcart</sub> and MPI<sub>neighbor</sub> alltoallw</p></li>
</ul>
<p>Independet of the way it is implement, on step of comms must look like
(ghost cells are printed and a new line added per process)</p>
<p><strong>Exercise</strong></p>
<p>Implement the communication pattern using simple senc and recv</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TODO</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="c1">// parallel versions</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">N</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// problem partition</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">np</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// include ghosts</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">NROWS</span><span class="o">*</span><span class="n">NCOLS</span><span class="p">);</span><span class="w"> </span><span class="c1">// include ghosts cells</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After initial conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After boundary conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="n">send_rows</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="c1">//send_rows_non_blocking(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="c1">//send_rows_sendrecv(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="c1">//send_rows_topology(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After one comm ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">  // Serial version</span>
<span class="cm">  Matrix data(N*N);</span>
<span class="cm">  initial_conditions(data, N, N, ...);</span>
<span class="cm">  print_screen(...);</span>
<span class="cm">  boundary_conditions(data, N, N, ...);</span>
<span class="cm">  init_gnuplot();</span>
<span class="cm">  for (int istep = 0; istep &lt; STEPS; ++istep) {</span>
<span class="cm">  evolve(data, N, N);</span>
<span class="cm">  plot_gnuplot(data, DELTA, N, N);</span>
<span class="cm">  }</span>
<span class="cm">  */</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// Parallel implementations</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// same task for all pids, but fill with the pids to distinguish among thems</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">boundary</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">print</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imin</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">imax</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">send</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// send data forwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r1</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//MPI_Send(&amp;m[(nrows-2)*ncols], ncols, MPI_DOUBLE, pid+1, 0, MPI_COMM_WORLD);</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// send data backwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r2</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// send data forwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// send data backwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span><span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">np</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create a cartesian 1D topology representing the non-periodic ring</span>
<span class="w">  </span><span class="c1">// https://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture28.pdf</span>
<span class="w">  </span><span class="c1">// https://www.codingame.com/playgrounds/47058/have-fun-with-mpi-in-c/mpi-process-topologies</span>
<span class="w">  </span><span class="c1">// MPI_Cart_create(MPI_Comm old_comm, int ndims, const int *dims, const int *periods, int reorder, MPI_Comm *comm_cart)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">reorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">dimsize</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="n">np</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">periods</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Cart_create</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dimsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">periods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">reorder</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">comm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Now use the network topology to communicate data in one pass for each direction</span>
<span class="w">  </span><span class="c1">// https://www.open-mpi.org/doc/v3.0/man3/MPI_Neighbor_alltoallw.3.php</span>
<span class="w">  </span><span class="c1">// https://www.events.prace-ri.eu/event/967/contributions/1110/attachments/1287/2213/MPI_virtual_topologies.pdf</span>
<span class="w">  </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">};</span>
<span class="w">  </span><span class="c1">// NOTE: scounts[0] goes with rcounts[1] (left and right)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">scounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rcounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Aint</span><span class="w"> </span><span class="n">sdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]{</span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="n">rdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to next</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from next</span>
<span class="w">  </span><span class="n">MPI_Neighbor_alltoallw</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">scounts</span><span class="p">,</span><span class="w"> </span><span class="n">sdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span>
<span class="w">                         </span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">rcounts</span><span class="p">,</span><span class="w"> </span><span class="n">rdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// SERIAL VERSIONS</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// check if boundary</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// evolve non boundary</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ii</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jj</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set terminal gif animate &quot; &lt;&lt; std::endl;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set out &#39;anim.gif&#39; &quot; &lt;&lt; std::endl;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">send</span> <span class="n">data</span> <span class="n">forwards</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">pid</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">//</span> <span class="n">send</span> <span class="n">data</span> <span class="n">backwards</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">pid</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>❯<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">6</span><span class="w"> </span>--oversubscribe<span class="w"> </span>./a.out<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">1</span>.4705<span class="w"> </span><span class="m">1</span>
<span class="w"> </span>After<span class="w"> </span>initial<span class="w"> </span>conditions<span class="w"> </span>...
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span>
<span class="w">  </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span>

<span class="w">  </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span>
<span class="w">  </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span>

<span class="w">  </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span>
<span class="w">  </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span>

<span class="w">  </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span>
<span class="w">  </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span>

<span class="w">  </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span>
<span class="w">  </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span>

<span class="w"> </span>After<span class="w"> </span>boundary<span class="w"> </span>conditions<span class="w"> </span>...
<span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>

<span class="w"> </span>After<span class="w"> </span>one<span class="w"> </span>comm<span class="w"> </span>...
<span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span>
<span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">3</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">0</span>

<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">5</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span>
</pre></div>
</div>
<p><strong>Exercise</strong> For a very large array, compute the bandwidth of each
procedure as a function of the number of process.</p>
</section>
<section id="evolution">
<h3><span class="section-number">15.7.4. </span>Evolution<a class="headerlink" href="#evolution" title="Permalink to this heading">#</a></h3>
<p>In this case we will just move form the serial simple evolution to
comms+evolution at each time step</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="c1">// parallel versions</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">N</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// problem partition</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">np</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// include ghosts</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">NROWS</span><span class="o">*</span><span class="n">NCOLS</span><span class="p">);</span><span class="w"> </span><span class="c1">// include ghosts cells</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After initial conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After boundary conditions ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="c1">//send_rows(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="c1">//send_rows_non_blocking(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="c1">//send_rows_sendrecv(data, NROWS, NCOLS, pid, np); // todo</span>
<span class="w">  </span><span class="n">send_rows_topology</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After one comm ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After one relax step ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">evolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="n">send_rows_topology</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; After one relax step ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;}</span>
<span class="w">  </span><span class="n">evolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="n">send_rows_topology</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="n">print_screen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">  // Serial version</span>
<span class="cm">  Matrix data(N*N);</span>
<span class="cm">  initial_conditions(data, N, N, ...);</span>
<span class="cm">  print_screen(...);</span>
<span class="cm">  boundary_conditions(data, N, N, ...);</span>
<span class="cm">  init_gnuplot();</span>
<span class="cm">  for (int istep = 0; istep &lt; STEPS; ++istep) {</span>
<span class="cm">  evolve(data, N, N);</span>
<span class="cm">  plot_gnuplot(data, DELTA, N, N);</span>
<span class="cm">  }</span>
<span class="cm">  */</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// Parallel implementations</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// same task for all pids, but fill with the pids to distinguish among thems</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">boundary</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="w">    </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">print</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="w">    </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">precision</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imin</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">imax</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">send</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="w">    </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// send data forwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r1</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//MPI_Send(&amp;m[(nrows-2)*ncols], ncols, MPI_DOUBLE, pid+1, 0, MPI_COMM_WORLD);</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// send data backwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r2</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// send data forwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// send data backwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span><span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">np</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create a cartesian 1D topology representing the non-periodic ring</span>
<span class="w">  </span><span class="c1">// https://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture28.pdf</span>
<span class="w">  </span><span class="c1">// https://www.codingame.com/playgrounds/47058/have-fun-with-mpi-in-c/mpi-process-topologies</span>
<span class="w">  </span><span class="c1">// MPI_Cart_create(MPI_Comm old_comm, int ndims, const int *dims, const int *periods, int reorder, MPI_Comm *comm_cart)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">reorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">dimsize</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="n">np</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">periods</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Cart_create</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dimsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">periods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">reorder</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">comm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Now use the network topology to communicate data in one pass for each direction</span>
<span class="w">  </span><span class="c1">// https://www.open-mpi.org/doc/v3.0/man3/MPI_Neighbor_alltoallw.3.php</span>
<span class="w">  </span><span class="c1">// https://www.events.prace-ri.eu/event/967/contributions/1110/attachments/1287/2213/MPI_virtual_topologies.pdf</span>
<span class="w">  </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">};</span>
<span class="w">  </span><span class="c1">// NOTE: scounts[0] goes with rcounts[1] (left and right)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">scounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rcounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Aint</span><span class="w"> </span><span class="n">sdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]{</span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="n">rdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to next</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from next</span>
<span class="w">  </span><span class="n">MPI_Neighbor_alltoallw</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">scounts</span><span class="p">,</span><span class="w"> </span><span class="n">sdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span>
<span class="w">                         </span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">rcounts</span><span class="p">,</span><span class="w"> </span><span class="n">rdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">evolve</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// SERIAL VERSIONS</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span>
<span class="w">    </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// check if boundary</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// evolve non boundary</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="o">+</span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[(</span><span class="n">ii</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span>
<span class="w">                        </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ii</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jj</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set terminal gif animate &quot; &lt;&lt; std::endl;</span>
<span class="w">  </span><span class="c1">//std::cout &lt;&lt; &quot;set out &#39;anim.gif&#39; &quot; &lt;&lt; std::endl;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we can just perform the relaxation step many times and create the
animation after parallelizing gnuplot printing:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span><span class="w"> </span><span class="c1">// alias</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">);</span>

<span class="c1">// parallel versions</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">N</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// problem partition</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">np</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// include ghosts</span>
<span class="w">  </span><span class="n">Matrix</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">NROWS</span><span class="o">*</span><span class="n">NCOLS</span><span class="p">);</span><span class="w"> </span><span class="c1">// include ghosts cells</span>
<span class="w">  </span><span class="n">initial_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">  </span><span class="c1">//if (0 == pid) {std::cout &lt;&lt; &quot; After initial conditions ...\n&quot;;}</span>
<span class="w">  </span><span class="c1">//print_screen(data, NROWS, NCOLS, pid, np); // todo</span>

<span class="w">  </span><span class="n">boundary_conditions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">NROWS</span><span class="p">,</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span><span class="w"> </span><span class="c1">// todo</span>
<span class="w">  </span><span class="c1">//if (0 == pid) {std::cout &lt;&lt; &quot; After boundary conditions ...\n&quot;;}</span>
<span class="w">  </span><span class="c1">//print_screen(data, NROWS, NCOLS, pid, np, true); // todo</span>


<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">anim</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>

<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">/////////////////////////////////////////////////////</span>
<span class="c1">// Parallel implementations</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initial_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// same task for all pids, but fill with the pids to distinguish among thems</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">boundary_conditions</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">boundary</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_screen</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">print</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ghosts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">imin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">imax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">precision</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imin</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">imax</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">send</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_non_blocking</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// send data forwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r1</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//MPI_Send(&amp;m[(nrows-2)*ncols], ncols, MPI_DOUBLE, pid+1, 0, MPI_COMM_WORLD);</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// send data backwards</span>
<span class="w">  </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r2</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_sendrecv</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">np</span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// send data forwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// send data backwards</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span><span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">np</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">m</span><span class="p">[(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">],</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">send_rows_topology</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create a cartesian 1D topology representing the non-periodic ring</span>
<span class="w">  </span><span class="c1">// https://wgropp.cs.illinois.edu/courses/cs598-s15/lectures/lecture28.pdf</span>
<span class="w">  </span><span class="c1">// https://www.codingame.com/playgrounds/47058/have-fun-with-mpi-in-c/mpi-process-topologies</span>
<span class="w">  </span><span class="c1">// MPI_Cart_create(MPI_Comm old_comm, int ndims, const int *dims, const int *periods, int reorder, MPI_Comm *comm_cart)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">reorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">dimsize</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="n">np</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">periods</span><span class="p">[</span><span class="n">ndims</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Cart_create</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dimsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">periods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">reorder</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">comm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Now use the network topology to communicate data in one pass for each direction</span>
<span class="w">  </span><span class="c1">// https://www.open-mpi.org/doc/v3.0/man3/MPI_Neighbor_alltoallw.3.php</span>
<span class="w">  </span><span class="c1">// https://www.events.prace-ri.eu/event/967/contributions/1110/attachments/1287/2213/MPI_virtual_topologies.pdf</span>
<span class="w">  </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">};</span>
<span class="w">  </span><span class="c1">// NOTE: scounts[0] goes with rcounts[1] (left and right)</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">scounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rcounts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Aint</span><span class="w"> </span><span class="n">sdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]{</span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="n">rdispl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-2</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to next</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sdispl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// send to previous</span>
<span class="w">  </span><span class="n">MPI_Get_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rdispl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// receive from next</span>
<span class="w">  </span><span class="n">MPI_Neighbor_alltoallw</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">scounts</span><span class="p">,</span><span class="w"> </span><span class="n">sdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span>
<span class="w">                         </span><span class="n">MPI_BOTTOM</span><span class="p">,</span><span class="w"> </span><span class="n">rcounts</span><span class="p">,</span><span class="w"> </span><span class="n">rdispl</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="o">&lt;&lt;</span><span class="n">evolve</span><span class="o">-</span><span class="n">student</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_gnuplot</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set contour &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set terminal gif animate &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set out &#39;anim.gif&#39; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">plot_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;splot &#39;-&#39; w pm3d &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// print master data</span>
<span class="w">    </span><span class="n">print_slab_gnuplot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// now receive and print other pdis data</span>
<span class="w">    </span><span class="n">Matrix</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ipid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ipid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">np</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ipid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">ipid</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
<span class="w">      </span><span class="n">print_slab_gnuplot</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;e&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// workers send</span>
<span class="w">    </span><span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_slab_gnuplot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ncols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// needs to fix local index with global ones</span>
<span class="w">  </span><span class="c1">// ignore ghosts</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="o">&lt;</span><span class="n">nrows</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">jj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="o">&lt;</span><span class="n">ncols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">jj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="mi">-1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nrows</span><span class="o">*</span><span class="n">pid</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">jj</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">ncols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="id1">
<h4><span class="section-number">15.7.4.1. </span>Exercises<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<p>Parallelize the code used on the relaxation method to solve the Poisson
equation, including some charge densities and some ineer boundary
conditions. Here you will need to decompose the domain, keep some ghost
zones, and share some info across processes to update the ghost zones.</p>
</section>
</section>
</section>
<section id="debugging-in-parallel">
<h2><span class="section-number">15.8. </span>Debugging in parallel<a class="headerlink" href="#debugging-in-parallel" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.open-mpi.org/faq/?category=debugging">https://www.open-mpi.org/faq/?category=debugging</a></p></li>
<li><p><a class="github reference external" href="https://github.com/Azrael3000/tmpi">Azrael3000/tmpi</a></p></li>
<li><p><a class="reference external" href="https://stackoverflow.com/questions/329259/how-do-i-debug-an-mpi-program">https://stackoverflow.com/questions/329259/how-do-i-debug-an-mpi-program</a></p></li>
<li><p><a class="reference external" href="https://hpc.llnl.gov/software/development-environment-software/stat-stack-trace-analysis-tool">https://hpc.llnl.gov/software/development-environment-software/stat-stack-trace-analysis-tool</a></p></li>
</ul>
<p>wget
<a class="reference external" href="https://epcced.github.io/2022-04-19-archer2-intro-develop/files/gdb4hpc_exercise.c">https://epcced.github.io/2022-04-19-archer2-intro-develop/files/gdb4hpc_exercise.c</a></p>
</section>
<section id="more-exercises">
<h2><span class="section-number">15.9. </span>More Exercises<a class="headerlink" href="#more-exercises" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Check the exercises on
<a class="reference external" href="https://computing.llnl.gov/tutorials/mpi/#Exercise1">https://computing.llnl.gov/tutorials/mpi/#Exercise1</a>,
<a class="reference external" href="https://computing.llnl.gov/tutorials/mpi/#Exercise2">https://computing.llnl.gov/tutorials/mpi/#Exercise2</a>, and
<a class="reference external" href="https://computing.llnl.gov/tutorials/mpi/#Exercise3">https://computing.llnl.gov/tutorials/mpi/#Exercise3</a> .</p></li>
<li><p>Check <a class="reference external" href="https://www.nics.tennessee.edu/mpi-tutorial">https://www.nics.tennessee.edu/mpi-tutorial</a></p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./14-MPI"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../13-OpenMP/OpenMP-Intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">14. </span>Introduction to OpenMp (Shared memory)</p>
      </div>
    </a>
    <a class="right-next"
       href="../15-Intro-Cuda/cuda.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">16. </span>Ref</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intro-mpi">15.1. Intro MPI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-mpi">15.2. Core MPI</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-sub-getprocessorname-sub">15.2.1. MPI<sub>Getprocessorname</sub></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-and-running-the-mpi-program">15.2.2. Compiling and running the MPI program</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-an-mpi-on-several-machines">15.2.3. Running an mpi on several machines</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-numerical-integration-send-and-recv-functions">15.3. Application: Numerical Integration (Send and Recv functions)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serial-implementation-of-the-numerical-integration-by-rectangles">15.3.1. Serial implementation of the numerical integration by rectangles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-solution-point-to-point-communication-with-mpi-sub-send-sub-and-mpi-sub-recv-sub">15.3.2. MPI solution: Point to point communication with MPI<sub>Send</sub> and MPI<sub>Recv</sub></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-point-to-point-exercises">15.4. More Point to point exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ping-pong">15.4.1. Ping-Pong</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bandwitdh-local-and-network">15.4.2. Bandwitdh local and network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#large-unit-matrix">15.4.3. Large unit matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ring-pattern">15.4.4. Ring pattern</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#collective-communications">15.5. Collective Communications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-bcast">15.5.1. MPI Bcast</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-sub-bcast-sub-mpi-sub-reduce-sub">15.5.2. MPI<sub>Bcast</sub>, MPI<sub>Reduce</sub></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">15.5.2.1. Exercises</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples-mpi-gather-mpi-scatter">15.6. More examples : <code class="docutils literal notranslate"><span class="pre">MPI_Gather</span></code>, <code class="docutils literal notranslate"><span class="pre">MPI_Scatter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collective-comms-exercises">15.6.1. Collective comms exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-example-parallel-relaxation-method">15.7. Practical example: Parallel Relaxation method</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serial-version">15.7.1. Serial version</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelize-both-initial-and-boundary-conditions">15.7.2. Parallelize both initial and boundary conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#communication">15.7.3. Communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evolution">15.7.4. Evolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">15.7.4.1. Exercises</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-in-parallel">15.8. Debugging in parallel</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-exercises">15.9. More Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By William Oquendo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>